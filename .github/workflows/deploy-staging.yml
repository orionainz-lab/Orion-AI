name: Deploy to Staging

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.12'
  NODE_VERSION: '22'

jobs:
  deploy-backend-staging:
    name: Deploy Backend to Railway Staging
    runs-on: ubuntu-latest
    environment:
      name: staging
      url: https://api-staging.railway.app
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Railway CLI
        run: npm install -g @railway/cli
      
      - name: Deploy to Railway
        run: railway up --service api-staging --environment staging
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN_STAGING }}
      
      - name: Wait for deployment
        run: sleep 30
      
      - name: Health check
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" https://api-staging.railway.app/health)
          if [ $response -eq 200 ]; then
            echo "✅ Backend health check passed"
          else
            echo "❌ Backend health check failed with status $response"
            exit 1
          fi

  deploy-frontend-staging:
    name: Deploy Frontend to Vercel Staging
    runs-on: ubuntu-latest
    needs: deploy-backend-staging
    environment:
      name: staging
      url: https://orion-ai-staging.vercel.app
    defaults:
      run:
        working-directory: ./frontend
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Install Vercel CLI
        run: npm install -g vercel
      
      - name: Pull Vercel Environment
        run: vercel pull --yes --environment=preview --token=${{ secrets.VERCEL_TOKEN }}
      
      - name: Build Project
        run: vercel build --token=${{ secrets.VERCEL_TOKEN }}
      
      - name: Deploy to Vercel
        run: vercel deploy --prebuilt --token=${{ secrets.VERCEL_TOKEN }}

  smoke-tests:
    name: Run Smoke Tests
    runs-on: ubuntu-latest
    needs: [deploy-backend-staging, deploy-frontend-staging]
    steps:
      - uses: actions/checkout@v4
      
      - name: Test Frontend Homepage
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" https://orion-ai-staging.vercel.app)
          if [ $response -eq 200 ]; then
            echo "✅ Frontend smoke test passed"
          else
            echo "❌ Frontend smoke test failed with status $response"
            exit 1
          fi
      
      - name: Test API Health
        run: |
          response=$(curl -s https://api-staging.railway.app/health)
          status=$(echo $response | jq -r '.status')
          if [ "$status" = "healthy" ]; then
            echo "✅ API health check passed"
          else
            echo "❌ API health check failed: $response"
            exit 1
          fi
      
      - name: Test API Detailed Health
        run: |
          curl -s https://api-staging.railway.app/health/detailed | jq

  notify:
    name: Notify Team
    runs-on: ubuntu-latest
    needs: smoke-tests
    if: always()
    steps:
      - name: Send notification
        run: |
          if [ "${{ needs.smoke-tests.result }}" = "success" ]; then
            echo "✅ Staging deployment successful"
          else
            echo "❌ Staging deployment failed"
          fi
